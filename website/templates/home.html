{% extends "base.html" %}

{% block title %}Browse Books{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div>
        <h1 style="font-family:Georgia, serif; font-size:32px; margin: 0;">Browse Books</h1>
        <p style="color:#777; margin: 5px 0 0;">Discover books from other readers</p>
    </div>
    
    <div style="position: relative; width: 300px;">
        <input type="text" id="bookSearch" onkeyup="filterBooks()" placeholder="Search by title or author..." 
               style="width: 100%; padding: 12px 15px; border-radius: 25px; border: 1px solid #ddd; outline: none;">
    </div>
</div>

<div id="bookGrid" style="
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
    gap:24px;
    margin-top:30px;
">

{% for book in books %}
    {% if book.owner_id != current_user.id %}
    <div class="book-card" style="
        background:#fff;
        border:1px solid #eee;
        border-radius:16px;
        overflow:hidden;
        display: flex;
        flex-direction: column;
        height: 100%;
    ">
        <div style="width: 100%; height: 320px; background: #f9f9f9; overflow: hidden;">
            <img src="{{ url_for('static', filename='uploads/' + book.image) if book.image else url_for('static', filename='images/default_book.jpg') }}" 
                 style="width:100%; height:100%; object-fit:cover; display: block;"
                 alt="{{ book.title }}">
        </div>

        <div style="padding:18px; display: flex; flex-direction: column; flex-grow: 1;">
            <h3 class="book-title" style="margin:0; font-size: 1.1rem; line-height: 1.2;">{{ book.title }}</h3>
            <p class="book-author" style="color:#777; margin:6px 0; font-size: 0.9rem;">{{ book.author }}</p>

            <p style="font-size:14px; color:#555; height: 42px; overflow: hidden; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                {{ book.description if book.description else "No description available." }}
            </p>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top: auto;">
                <strong style="color:#d68a1a;">
                    {% if book.sell_detail and book.sell_detail|length > 0 %}
                        â‚¹{{ book.sell_detail[0].price }}
                    {% elif book.borrow_detail %}
                        Borrow
                    {% else %}
                        Barter
                    {% endif %}
                </strong>

                {% if book.sell_detail and book.sell_detail|length > 0 %}
                    <a href="{{ url_for('routes.buy_book', book_id=book.id) }}"
                       style="background:#27ae60; color:white; padding:8px 14px; border-radius:8px; text-decoration:none; font-size: 14px; font-weight: 600;">
                       Buy
                    </a>
                {% elif book.borrow_detail %}
                    <button onclick="openBorrowModal('{{ book.id }}', '{{ book.title }}', '{{ book.author }}', '{{ url_for('static', filename='uploads/' + book.image) if book.image else url_for('static', filename='images/default_book.jpg') }}')"
                       style="background:#2980b9; color:white; padding:8px 14px; border-radius:8px; border:none; cursor:pointer; font-size: 14px; font-weight: 600;">
                       Borrow
                    </button>
                {% else %}
                    <button onclick="openBarterModal('{{ book.id }}', '{{ book.title }}', '{{ book.author }}', '{{ url_for('static', filename='uploads/' + book.image) if book.image else url_for('static', filename='images/default_book.jpg') }}')"
                       style="background:#8e44ad; color:white; padding:8px 14px; border-radius:8px; border:none; cursor:pointer; font-size: 14px; font-weight: 600;">
                       Barter
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
{% endfor %}
</div>

<div id="borrowModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div style="background:white; width:90%; max-width:450px; border-radius:16px; overflow:hidden;">
        <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; font-size: 18px;"><span style="color:#2980b9;">ðŸ•’</span> Request to Borrow</h3>
            <span onclick="closeModal('borrowModal')" style="cursor:pointer; font-size:24px; color:#aaa;">&times;</span>
        </div>
        <div style="padding: 15px; display: flex; gap: 15px; align-items: center; background: #fafafa;">
            <img id="borrowBookImg" src="" style="width: 60px; height: 80px; object-fit: cover; border-radius: 8px;">
            <div>
                <h4 id="borrowBookTitle" style="margin: 0; font-size: 16px;"></h4>
                <p id="borrowBookAuthor" style="margin: 5px 0 0; color: #777; font-size: 14px;"></p>
            </div>
        </div>
        <form id="borrowForm" method="POST" style="padding: 20px;">
            <label style="display:block; margin-bottom:8px; font-weight:600;">Borrow Duration *</label>
            <select name="days" required style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom: 15px;">
                <option value="" disabled selected>How long do you need it?</option>
                <option value="7">1 Week</option>
                <option value="14">2 Weeks</option>
                <option value="30">1 Month</option>
            </select>
            <label style="display:block; margin-bottom:8px; font-weight:600;">Message (optional)</label>
            <textarea name="message" placeholder="Message to the owner..." style="width:100%; height:70px; padding:10px; border:1px solid #ddd; border-radius:8px; resize: none;"></textarea>
            <button type="submit" style="width:100%; background:#2980b9; color:white; padding:12px; border:none; border-radius:10px; font-weight:bold; cursor:pointer; margin-top: 15px;">Send Borrow Request</button>
        </form>
    </div>
</div>

<div id="barterModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div style="background:white; width:90%; max-width:450px; border-radius:16px; overflow:hidden;">
        <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; font-size: 18px;"><span style="color:#8e44ad;">ðŸ”„</span> Propose a Barter</h3>
            <span onclick="closeModal('barterModal')" style="cursor:pointer; font-size:24px; color:#aaa;">&times;</span>
        </div>
        
        <div style="padding: 15px; display: flex; gap: 15px; align-items: center; background: #fafafa;">
            <img id="barterBookImg" src="" style="width: 60px; height: 80px; object-fit: cover; border-radius: 8px;">
            <div>
                <h4 id="barterBookTitle" style="margin: 0; font-size: 16px;"></h4>
                <p id="barterBookAuthor" style="margin: 5px 0 0; color: #777; font-size: 14px;"></p>
            </div>
        </div>

        <form id="barterForm" method="POST" enctype="multipart/form-data" style="padding: 20px; max-height: 450px; overflow-y: auto;">
            <label style="display:block; margin-bottom:5px; font-weight:600; font-size: 14px;">Your book to exchange:</label>
            
            <input type="text" name="offered_book_title" placeholder="Book Title *" required style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom: 10px;">
            
            <input type="text" name="offered_book_author" placeholder="Author's Name" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom: 10px;">
            
            <input type="text" name="offered_book_genre" placeholder="Genre" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom: 10px;">

            <label style="display:block; margin-bottom:5px; font-weight:600; font-size: 14px;">Upload Image of your Book:</label>
            <input type="file" name="offered_book_image" accept="image/*" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom: 10px; font-size: 13px;">
            
            <textarea name="message" placeholder="Message (optional)" style="width:100%; height:60px; padding:10px; border:1px solid #ddd; border-radius:8px; resize: none;"></textarea>
            
            <button type="submit" style="width:100%; background:#8e44ad; color:white; padding:12px; border:none; border-radius:10px; font-weight:bold; cursor:pointer; margin-top: 15px;">Send Barter Offer</button>
        </form>
    </div>
</div>

<script>
// Search Functionality
function filterBooks() {
    let input = document.getElementById('bookSearch').value.toLowerCase();
    let cards = document.getElementsByClassName('book-card');
    
    for (let i = 0; i < cards.length; i++) {
        let title = cards[i].querySelector('.book-title').innerText.toLowerCase();
        let author = cards[i].querySelector('.book-author').innerText.toLowerCase();
        
        if (title.includes(input) || author.includes(input)) {
            cards[i].style.display = "";
        } else {
            cards[i].style.display = "none";
        }
    }
}

function openBorrowModal(id, title, author, img) {
    document.getElementById('borrowBookImg').src = img;
    document.getElementById('borrowBookTitle').innerText = title;
    document.getElementById('borrowBookAuthor').innerText = author;
    document.getElementById('borrowForm').action = "/borrow/" + id;
    document.getElementById('borrowModal').style.display = 'flex';
}

function openBarterModal(id, title, author, img) {
    document.getElementById('barterBookImg').src = img;
    document.getElementById('barterBookTitle').innerText = title;
    document.getElementById('barterBookAuthor').innerText = author;
    document.getElementById('barterForm').action = "/barter/" + id;
    document.getElementById('barterModal').style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

window.onclick = function(event) {
    if (event.target.id.endsWith('Modal')) {
        event.target.style.display = "none";
    }
}
</script>
{% endblock %}