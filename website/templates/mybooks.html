{% extends "base.html" %}

{% block title %}My Books | BookSwap{% endblock %}

{% block extra_style %}
<style>
/* PAGE-SPECIFIC STYLES ONLY */
h1 { font-family: Georgia, serif; }
.subtitle { color: var(--muted); margin-bottom: 30px; }

/* Tabs */
.tabs { display: inline-flex; background: #f0ede7; border-radius: 12px; padding: 4px; margin-bottom: 30px; }
.tab { padding: 10px 20px; border-radius: 10px; cursor: pointer; color: var(--muted); }
.tab.active { background: white; color: var(--text); box-shadow: 0 2px 6px rgba(0,0,0,.05); }

/* Cards */
.card { background: var(--card); border: 1px solid var(--border); border-radius: 18px; padding: 20px; margin-bottom: 20px; }
.book-row { display: flex; gap: 20px; align-items: center; }
.book-row img { width: 90px; height: 120px; object-fit: cover; border-radius: 10px; }
.price { color: var(--primary); font-weight: bold; }
.badge { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; background: #f0f0f0; }
.type-indicator { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--primary); font-weight: bold; margin-bottom: 5px; display: block; }
.hidden { display: none; }

/* Buttons */
.btn-action { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; margin-right: 5px; }
.btn-accept { background: #27ae60; color: white; }
.btn-reject { background: #e74c3c; color: white; }
</style>
{% endblock %}

{% block content %}

<h1>My Books</h1>
<p class="subtitle">Manage your listed books and incoming requests</p>

<div class="tabs">
    <div class="tab active" onclick="showTab('listings')">
        My Listings ({{ listings|length }})
    </div>
    <div class="tab" onclick="showTab('requests_div')">
        Requests ({{ requests|length }})
    </div>
</div>

<div id="listings">
    {% for book in listings %}
    <div class="card">
        <div class="book-row">
            <img src="{{ url_for('static', filename='uploads/' + book.image) if book.image else url_for('static', filename='default_book.jpg') }}">
            <div>
                <h3>{{ book.title }}</h3>
                <p>{{ book.author }}</p>
                <div class="price">
                    {% if book.sell_detail %}
                        â‚¹{{ book.sell_detail[0].price }}
                    {% elif book.borrow_detail %}
                        Borrow 
                    {% else %}
                        Barter 
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <p>No books uploaded yet.</p>
    {% endfor %}
</div>

<div id="requests_div" class="hidden">
    {% for req in requests %}
    <div class="card">
        <span class="type-indicator">{{ req.type|upper }} REQUEST</span>
        
        {% if req.type == 'borrow' %}
            <p><b>Book:</b> {{ req.book.title }}</p>
            <p><b>From:</b> {{ req.borrower.username }}</p>
            <p><b>Duration:</b> {{ req.days }} days</p>
        {% else %}
            <p><b>Your Book:</b> {{ req.requested_book.title }}</p>
            <p><b>Offered:</b> {{ req.offered_book_title }} ({{ req.offered_book_genre }})</p>
            <p><b>From:</b> {{ req.requester.username }}</p>
        {% endif %}
        
        <p><b>Status:</b> <span class="badge">{{ req.status|capitalize }}</span></p>

        {% if req.status == 'pending' %}
        <div style="display:flex; margin-top:10px;">
            <form method="POST" action="{{ url_for('routes.handle_request', req_type=req.type, req_id=req.id, action='accept') }}">
                <button class="btn-action btn-accept">Accept</button>
            </form>
            <form method="POST" action="{{ url_for('routes.handle_request', req_type=req.type, req_id=req.id, action='reject') }}">
                <button class="btn-action btn-reject">Reject</button>
            </form>
        </div>
        {% endif %}
    </div>
    {% else %}
    <p>No incoming requests yet.</p>
    {% endfor %}
</div>

{% endblock %}

{% block extra_js %}
<script>
function showTab(tab) {
    // Hide both main containers
    document.getElementById('listings').classList.add('hidden');
    document.getElementById('requests_div').classList.add('hidden');
    
    // Remove active class from all tabs
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

    if (tab === 'listings') {
        document.getElementById('listings').classList.remove('hidden');
        document.querySelectorAll('.tab')[0].classList.add('active');
    } else {
        document.getElementById('requests_div').classList.remove('hidden');
        document.querySelectorAll('.tab')[1].classList.add('active');
    }
}
</script>
{% endblock %}